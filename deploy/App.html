<!DOCTYPE html>
<html>
<head>
    <title>ProjectTree</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CArABU.technicalservices.FileUtilities",{singleton:!0,saveCSVToFile:function(e,t,r){void 0==r&&(r={type:"text/csv;charset=utf-8"});var o=new Blob([e],r);saveAs(o,t)},saveTextAsFile:function(e,t){var r=new Blob([e],{type:"text/plain"}),o=t,n=document.createElement("a");n.download=o,n.innerHTML="Download File",null!=window.webkitURL?n.href=window.webkitURL.createObjectURL(r):(n.href=window.URL.createObjectURL(r),n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n)),n.click()},destroyClickedElement:function(e){document.body.removeChild(e.target)},convertDataArrayToCSVText:function(e,t){var r="";return Ext.each(Object.keys(t),function(e){r+=t[e]+","}),r=r.replace(/,$/,"\n"),Ext.each(e,function(e){Ext.each(Object.keys(t),function(t){e[t]?"object"==typeof e[t]?e[t].FormattedID?r+=Ext.String.format('"{0}",',e[t].FormattedID):e[t].Name?r+=Ext.String.format('"{0}",',e[t].Name):isNaN(Date.parse(e[t]))?r+=Ext.String.format('"{0}",',e[t].toString()):r+=Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(e[t])):r+=Ext.String.format('"{0}",',e[t]):r+=","},this),r=r.replace(/,$/,"\n")},this),r},_getCSVFromWsapiBackedGrid:function(e){for(var t=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.wsapi.Store",{fetch:e.getStore().config.fetch,filters:e.getStore().config.filters,model:e.getStore().config.model,limit:1/0,pageSize:1/0}),o=e.columns,n=this._getHeadersFromGrid(e),a=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),i=e.getStore().pageSize,c=Math.ceil(a/i),l=[],s=1;s<=c;s++)l.push(this.loadStorePage(e,r,o,s,c));return Deft.Promise.all(l).then({success:function(e){var r=[];r.push('"'+n.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGridWithPaging:function(e){var t=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.custom.Store",{model:e.getStore().config.model,filters:e.getStore().config.filters,limit:1/0,pageSize:1/0}),o=e.columns,n=this._getHeadersFromGrid(e),a=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),i=e.getStore().pageSize,c=Math.ceil(a/i),l=[];return l.push(this.loadStorePage(e,r,o,page,c)),Deft.Promise.all(l).then({success:function(e){var r=[];r.push('"'+n.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGrid:function(e){var t=Ext.create("Deft.Deferred"),r=this;Rally.getApp().setLoading("Assembling data for export...");var o=this._getHeadersFromGrid(e),n=Ext.clone(e.getStore()),a=e.columns,i=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),c=e.getStore().pageSize,l=Math.ceil(i/2e4);n.pageSize=2e4;for(var s=[],d=[],u=1;u<=l;u++)s.push(u);return Ext.Array.each(s,function(t){d.push(function(){return r._loadStorePage(e,n,a,t,s.length)})}),Deft.Chain.sequence(d).then({success:function(e){n.pageSize=c,n.loadPage(1);var r=[];r.push('"'+o.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_loadStorePage:function(e,t,r,o,n){var a=Ext.create("Deft.Deferred");return t.loadPage(o,{callback:function(r){for(var o=[],n=0;n<r.length;n++){var i=r[n];o.push(this._getCSVFromRecord(i,e,t))}a.resolve(o)},scope:this}),a.promise},_getHeadersFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&(e.csvText?t.push(e.csvText.replace("&nbsp;"," ")):e.text&&t.push(e.text.replace("&nbsp;"," ")))}),t},_getColumnNamesFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&t.push(e.dataIndex)}),t},getCSVFromGrid:function(e,t){return"Ext.data.TreeStore"!=Ext.getClassName(t.getStore())&&"Rally.data.custom.Store"!=Ext.getClassName(t.getStore())?this._getCSVFromWsapiBackedGrid(t):this._getCSVFromCustomBackedGrid(t)},loadStorePage:function(e,t,r,o,n){var a=Ext.create("Deft.Deferred");return t.loadPage(o,{callback:function(r,i,c){var l=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",o,n));for(var s=0;s<r.length;s++){var d=r[s];l.push(this._getCSVFromRecord(d,e,t))}a.resolve(l)},scope:this}),a},_getCSVFromRecord:function(e,t,r){var o={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},n=[],a=t.columns;return Ext.Array.each(a,function(a){if("rallyrowactioncolumn"!=a.xtype)if(a.dataIndex){var i=a.dataIndex,c=e.get(i);!a._csvIgnoreRender&&a.renderer&&(c=a.exportRenderer?a.exportRenderer(c,o,e,0,0,r,t.getView()):a.renderer(c,o,e,0,0,r,t.getView())),n.push(c)}else{c=null;!a._csvIgnoreRender&&a.renderer&&(c=a.exportRenderer?a.exportRenderer(c,o,e,e,0,0,r,t.getView()):a.renderer(c,o,e,e,0,0,r,t.getView()),n.push(c))}},this),'"'+n.join('","')+'"'}});
                Ext.define("Niks.ui.UserPopover",{alias:"widget.rallyuserpopover",extend:Rally.ui.popover.ListViewPopover,id:"user-popover",cls:"userstory-popover",title:"Users",titleIconCls:"icon-user",maxHeight:600,constructor:function(e){var t=Ext.getCmp("projectApp");e.listViewConfig=Ext.merge({model:Ext.identityFn("User"),childField:t.getSetting("userGroup"),addNewConfig:null,gridConfig:{stateful:!0,enableEditing:!1,store:e.recordStore,columnCfgs:[{dataIndex:"DisplayName",width:90},{dataIndex:"EmailAddress",flex:90},{dataIndex:"Role",width:180},{dataIndex:"UserName",width:180}]}},e.listViewConfig),this.callParent(arguments)}}),Ext.define("Rally.ui.tree.extendedTreeItem",{alias:"widget.extendedTreeItem",extend:"Rally.ui.tree.TreeItem",config:{displayedFields:["Name","Description","TeamMembers"]},initComponent:function(){this.callParent(arguments),this.on("afterrender",function(){this._getAutoExpanded()&&this.setExpanded(!0),this.draw(),this._getAutoExpanded()&&this.fireEvent("expand",this)},this)},_getAutoExpanded:function(){return this.up("#projectApp").getSetting("autoExpand")},_checkPermissions:function(e,t){var r=this.up("#projectApp"),n=r._findUser(e,r),i=_.filter(n.permissions,function(e){return e.get("Project")._ref===t.get("_ref")});if(0===i.length)return r.getSetting("showViewers")?"lightblue":null;var o=void 0!==_.find(i,function(e){return"Admin"===e.get("Role")});return r.getSetting("projectAdminsOnly")&&!o?null:void 0!==_.find(i,function(e){return"Editor"===e.get("Role")})?"lightgreen":o?"orange":"red"},getContentTpl:function(){var e=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses">{[this.getFormattedId()]} {[this.getSeparator()]}{Name} ({[this.getOwner()]})</div>','<div class="rightSide">',"</div>",{canDrag:function(){return e.getCanDrag()},getActionsGear:function(){return e._buildActionsGearHtml()},getFormattedId:function(){var t=e.getRecord();return t.getField("FormattedID")?Rally.ui.renderer.RendererFactory.renderRecordField(t,"FormattedID"):""},getSeparator:function(){return this.getFormattedId()?"- ":""},getOwner:function(){var t=e.getRecord();return t.getField("Owner")?Rally.ui.renderer.RendererFactory.renderRecordField(t,"Owner"):""}})},draw:function(){var e=this;this.content&&this.content.destroy();var t="treeItemContent";this.getSelectable()&&(t+=" selectable"),this.expander?this.toggleExpander():this.expander=this.drawExpander(),pe=window.document.getElementById(this.parentTreeItem?this.parentTreeItem.id:this.id),this.insert(1,{xtype:"container",itemId:"treeItemContent",id:Ext.id(),cls:t,layout:{type:"hbox"},items:[{xtype:"component",renderTpl:this.getContentTpl(),renderData:this.getRenderData(),listeners:{afterrender:function(){this.setupListeners()},scope:this}},{xtype:"fieldcontainer",itemId:"userInfoRecord",layout:{type:"anchor"},defaults:{layout:"100%"},style:{marginLeft:"50px",border:15},listeners:{afterrender:function(t){var r=e.getRecord(),n=this.up("#projectApp"),i=n.getSetting("userGroup");Rally.data.ModelFactory.getModel({type:"User",success:function(o){var s=r.getCollection(i,{filters:n._getFilters(n),fetch:["WorkspacePermission","EmailAddress","Role","Username","UserPermissions","TeamMemberships","DisplayName"]});s.load().then({success:function(n){s.model=o;var a=Ext.clone({record:r,target:t.getTargetEl(),field:i,title:i,autoShow:!0,recordStore:s});n.length>0&&t.getTargetEl().on("click",function(){Ext.create("Niks.ui.UserPopover",a)}),t.suspendLayouts(),_.each(n,function(n){var i=e._checkPermissions(n,r);if(null!==i){var o=Ext.clone({xtype:"textfield",readOnly:!0,border:"0 0 0 5",style:{borderColor:i,borderStyle:"solid",marginLeft:"10px"},value:n.get("_refObjectName")});t.add(o)}}),t.resumeLayouts(),t.updateLayout()}})},failure:function(){console.log("Failed to get model for 'User'")}})}}}]})}}),Ext.define("Niks.apps.ProjectTreeApp",{extend:"Rally.app.App",componentCls:"app",itemId:"projectApp",id:"projectApp",stateful:!0,items:[{xtype:"container",margin:"5 0 20 0",layout:"hbox",items:[{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 10px;padding-right: 20px">Permission Colour Coding:   </div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid red">Workspace Admin</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid orange">Project Admin</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid lightgreen">Project Editor</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid lightblue">Project Viewer</div>'}]}],config:{defaultSettings:{userGroup:"Editors",autoExpand:!0,projectAdminsOnly:!1,showViewers:!1}},getSettingsFields:function(){var e=this;return[{xtype:"rallycheckboxfield",fieldLabel:"Show Project Admins Only",labelWidth:200,name:"projectAdminsOnly"},{xtype:"radiogroup",fieldLabel:"User Type Selection",labelWidth:200,style:{borderColor:"#e0e0e0",borderStyle:"solid none",borderWidth:"thick"},name:"typeGroup",columns:1,items:[{boxLabel:"Editors",name:"userGroup",inputValue:"Editors"},{boxLabel:"Team Members",name:"userGroup",inputValue:"TeamMembers"}],listeners:{afterrender:function(t){t.setValue({userGroup:e.getSetting("userGroup")})}}},{xtype:"rallycheckboxfield",fieldLabel:"Auto Expand Tree",labelWidth:200,name:"autoExpand"},{xtype:"rallycheckboxfield",fieldLabel:"Show Viewers",labelWidth:200,name:"showViewers"}]},_getFilters:function(e){var t=[];return"TeamMembers"!==e.getSetting("userGroup")&&(t=[Rally.data.wsapi.Filter.or([{property:"WorkspacePermission",operator:"=",value:"Workspace User"},{property:"WorkspacePermission",operator:"=",value:"Project Admin"}])]),!0===e.getSetting("projectAdminsOnly")&&(t=[{property:"WorkspacePermission",value:"Project Admin"}]),t},userInfo:[],projectInfo:[],launch:function(){var e=this,t=Ext.create("Rally.ui.tree.ProjectTree",{config:{topLevelModel:"Project",treeItemConfigForRecordFn:function(e){return{xtype:"extendedTreeItem",selectable:!0}},topLevelStoreConfig:{fetch:["Name","Owner","State","Children:summary[State]","Workspace","Editors","TeamMembers"],hydrate:["Owner"],filters:[{property:"ObjectID",value:e.getContext().getProject().ObjectID}],sorters:[{property:"Name",direction:"ASC"}]},childItemsStoreConfigForParentRecordFn:function(e){return Ext.apply({fetch:["Name","Description","Owner","Children:summary[State]","State","Workspace"],hydrate:["Owner"],sorters:[{property:"Name",direction:"ASC"}]},{filters:[{property:"Parent",value:e.get("_ref")}],context:{workspace:e.get("Workspace")._ref,project:null}})},handleChildItemStoreLoad:function(t,r,n){var i=this;e._getUserDetails(r,e).then({success:function(t){_.each(t,function(t){e.userInfo.push(t)}),i.renderChildRecords(r,n)},failure:function(){console.log("Failed to get User details in handleChildItemStoreLoad")}})},handleParentItemStoreLoad:function(t,r){var n=this;e._getUserDetails(r,e).then({success:function(t){_.each(t,function(t){e.userInfo.push(t)}),n.renderParentRecords(r)},failure:function(){console.log("Failed to get User details in handleParentItemStoreLoad")}})}}});this.add(t)},_getUserDetails:function(e,t){var r=Ext.create("Deft.Deferred"),n=[];return _.each(e,function(e){var r=Ext.clone({filters:t._getFilters(t),fetch:["WorkspacePermission","UserPermissions","DisplayName"]});n.push(e.getCollection(t.getSetting("userGroup")).load(r))}),Deft.Promise.all(n).then({success:function(e){var n=[];_.each(e,function(e){0!==e.length&&_.each(e,function(e){void 0===t._findUser(e,t)&&n.push(e)})}),n.length>0?t._getUserPermissions(n).then({success:function(e){r.resolve(n)},failure:function(){console.log("Failed to get new users permissions for ",n),r.reject()}}):r.resolve()},failure:function(){console.log("Faailed to get users for projects"),r.reject()}}),r.promise},_getUserPermissions:function(e){var t=Ext.create("Deft.Deferred"),r=[];return _.each(e,function(e){var t=Ext.clone([{property:"User",value:e.get("_ref")},{property:"Workspace",value:Ext.getCmp("projectApp").getContext().getWorkspace()._ref}]);r.push(Ext.create("Rally.data.wsapi.Store",{model:"ProjectPermission",filters:t,listeners:{load:function(t,r){e.permissions=r}}}).load())}),Deft.Promise.all(r).then({success:function(e){t.resolve(e)},failure:function(){console.log("Failed in _getUserPermissions"),t.reject()}}),t.promise},_findUser:function(e,t){return _.find(t.userInfo,function(t){return t.get("_refObjectUUID")===e.get("_refObjectUUID")})}});

            Rally.launchApp('Niks.apps.ProjectTreeApp', {
                name:"ProjectTree",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
